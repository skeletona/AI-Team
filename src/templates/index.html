<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex Task Stats</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="orb orb-one"></div>
    <div class="orb orb-two"></div>
    <div class="orb orb-three"></div>
    <main class="page-shell">
      <header class="hero">
        <div class="hero-copy">
          <h1>AI Team Dashboard</h1>
        </div>
      </header>

      <section class="summary-and-budget">
        <div class="summary-grid">
          <article class="summary-card">
            <p class="label">Runs</p>
            <p class="value">{{ runs }}</p>
          </article>
          <article class="summary-card">
            <p class="label">Flags</p>
            <p class="value">{{ flags }}</p>
          </article>
          <article class="summary-card">
            <p class="label">Tokens</p>
            <p class="value">{{ tokens_used }}</p>
          </article>
        </div>

        <article class="budget-card">
          <header>
            <h2>Budget Watch</h2>
          </header>
          <div class="budget-bars">
            <div class="budget-row">
              <div class="budget-row-label">
                <span>5h limit</span>
                <span>{{ fill_5h }}%</span>
              </div>
              <div class="budget-track">
                <div class="budget-fill" style="width: {{ fill_5h }}%"></div>
              </div>
            </div>
            <div class="budget-row">
              <div class="budget-row-label">
                <span>Weekly limit</span>
              <span>{{ fill_week }}%</span>
              </div>
              <div class="budget-track">
                <div class="budget-fill" style="width: {{ fill_week }}%"></div>
              </div>
            </div>
          </div>
        </article>
      </section>

      <section class="thinking-stack">
        <header>
          <h2>Task Status</h2>
        </header>
        <div class="status-grid">
          {% macro status_panel(title, items, hint_text) %}
            <article class="status-panel" data-status="{{ title }}" data-drop-zone>
              <header>
                <h3>{{ title }}</h3>
                <span class="status-count">{{ items.len() }}</span>
              </header>
              <div class="status-items">
                {% for item in items %}
                  <a
                    href="/task/{{ item.id }}"
                    class="status-item"
                    data-status="{{ item.status }}"
                    data-task-id="{{ item.id }}"
                    draggable="true"
                  >
                    <div class="status-top-row">
                      <p class="task-name">{{ item.name }}</p>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </article>
          {% endmacro %}

          {{ status_panel("Queued",  cards[&TaskStatus::Queued],  "Waiting for execution") }}
          {{ status_panel("Running", cards[&TaskStatus::Running], "Currently burning tokens") }}
          {{ status_panel("Solved",  cards[&TaskStatus::Solved],  "Victories") }}
          {{ status_panel("Failed",  cards[&TaskStatus::Failed],  "Needs attention") }}
          {{ status_panel("Blocked", cards[&TaskStatus::Blocked], "Manually blocked from running") }}
        </div>
      </section>
    </main>
    <script>
      const draggableItems = document.querySelectorAll('[data-task-id]');
      const dropZones = document.querySelectorAll('[data-drop-zone]');

      draggableItems.forEach((item) => {
        item.addEventListener('dragstart', (event) => {
          event.dataTransfer.setData('text/plain', item.dataset.taskId);
          event.dataTransfer.effectAllowed = 'move';
          item.classList.add('dragging');
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
        });
      });

      dropZones.forEach((zone) => {
        zone.addEventListener('dragover', (event) => {
          event.preventDefault();
          zone.classList.add('drop-active');
        });

        zone.addEventListener('dragleave', () => {
          zone.classList.remove('drop-active');
        });

        zone.addEventListener('drop', (event) => {
          event.preventDefault();
          zone.classList.remove('drop-active');
          const taskId = event.dataTransfer.getData('text/plain');
          const nextStatus = zone.dataset.status;
          if (!taskId || !nextStatus) {
            return;
          }
          const dragged = document.querySelector(`[data-task-id="${taskId}"]`);
          const currentStatus = dragged ? dragged.dataset.status : null;
          if (currentStatus === nextStatus) {
            return;
          }
          fetch(`/api/task/${taskId}/status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: nextStatus }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                console.error(data.error);
                return;
              }
              window.location.reload();
            })
            .catch((error) => {
              console.error('Failed to update status', error);
            });
        });
      });
    </script>
  </body>
</html>
