<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Codex Task Log" }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>

  <body>
    <div class="orb orb-one"></div>
    <div class="orb orb-two"></div>
    <div class="orb orb-three"></div>
    <main class="page-shell">
      <header class="hero">
        <div class="hero-copy">
          <p class="eyebrow">AI-Team · Detailed Thinking</p>
          <h1>Challenge #{{ task_id }}</h1>
          <p class="hero-subtitle">
            {{ task_name or "Running codex log" }}
          </p>
        </div>
        <div class="hero-meta">
          <span class="status-pill status-{{ latest_status | lower }}">
            {{ latest_status | capitalize }}
          </span>
          <a class="hero-link hero-back" href="/">← Back to dashboard</a>
        </div>
      </header>

      <section class="detail-view detail-terminal-shell">
        <div class="thinking-content detail-thinking-content">
          <pre data-thinking-target>{{ text }}</pre>
        </div>
      </section>
    </main>

    <script>
      const thinkingContainer = document.querySelector('[data-thinking-target]');
      const thinkingStatus = document.querySelector('[data-thinking-status]');
      const taskId = {{ task_id }};

      function scrollToBottom() {
        console.log("sus")
        thinkingContainer.scrollTop = thinkingContainer.scrollHeight;
      }
      window.addEventListener('load', scrollToBottom);

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/task/${taskId}/update`;

      const ws = new WebSocket(wsUrl);

      ws.onmessage = function(event) {
        thinkingContainer.textContent += event.data;
        thinkingContainer.scrollTop = thinkingContainer.scrollHeight;
        scrollToBottom();
      };

      ws.onopen = function() {
        console.log("WebSocket connected.");
        // Sending a plain text message as the server expects it
        ws.send("start_log_stream:{{ task_id }}");
      };

      window.addEventListener('beforeunload', function() {
        if (ws.readyState === WebSocket.OPEN) {
          ws.close();
          console.log("WebSocket closed.");
        }
      });

      ws.onclose = function() {
        console.log('WebSocket connection closed');
      };

      ws.onerror = function(error) {
        console.error('WebSocket error:', error);
      };
    </script>
  </body>
</html>
