<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Codex Task Stats" }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="orb orb-one"></div>
    <div class="orb orb-two"></div>
    <div class="orb orb-three"></div>
    <main class="page-shell">
      <header class="hero">
        <div class="hero-copy">
          <p class="eyebrow">AI-Team Â· Automated CTF Coverage</p>
          <h1>{{ title or "Codex Task Stats" }}</h1>
          <p class="hero-subtitle">
            Autonomous fleet overview for every Codex-run challenge.
          </p>
        </div>
        <div class="hero-meta">
          <span class="status-pill status-{{ latest_status | lower }}">
            Latest status: {{ latest_status | capitalize }}
          </span>
        </div>
      </header>

      <section class="summary-and-budget">
        <div class="summary-grid">
          <article class="summary-card">
            <p class="label">{{ summary.runs_label or "Runs" }}</p>
            <p class="value">{{ summary.runs | default(0) }}</p>
            <p class="hint">logged attempts</p>
          </article>
          <article class="summary-card">
            <p class="label">Flags</p>
            <p class="value">{{ summary.flags | default(0) }}</p>
            <p class="hint">unique captures</p>
          </article>
          <article class="summary-card">
            <p class="label">Tokens</p>
            <p class="value">{{ summary.tokens | default(0) }}</p>
            <p class="hint">spent so far</p>
          </article>
        </div>

        <article class="budget-card">
          <header>
            <h2>Budget Watch</h2>
            <p class="hint">API limits + context window</p>
          </header>
          {% if budgets.lines %}
            <div class="budget-lines">
              {% for line in budgets.lines %}
                <p>{{ line }}</p>
              {% endfor %}
            </div>
          {% endif %}
          <div class="budget-bars">
            {% if budgets.limit_5h %}
              {% set tokens_5h = budgets.tokens_5h | default(0) %}
              {% set limit_5h = budgets.limit_5h %}
              {% set fill_5h = [((tokens_5h / limit_5h) * 100), 100] | min %}
              <div class="budget-row">
                <div class="budget-row-label">
                  <span>5h limit</span>
                  <span>{{ tokens_5h | round }} / {{ limit_5h }}</span>
                </div>
                <div class="budget-track">
                  <div class="budget-fill" style="width: {{ fill_5h }}%"></div>
                </div>
              </div>
            {% endif %}
            {% if budgets.limit_week %}
              {% set tokens_week = budgets.tokens_week | default(0) %}
              {% set limit_week = budgets.limit_week %}
              {% set fill_week = [((tokens_week / limit_week) * 100), 100] | min %}
              <div class="budget-row">
                <div class="budget-row-label">
                  <span>Weekly limit</span>
                  <span>{{ tokens_week | round }} / {{ limit_week }}</span>
                </div>
                <div class="budget-track">
                  <div class="budget-fill" style="width: {{ fill_week }}%"></div>
                </div>
              </div>
            {% endif %}
          </div>
        </article>
      </section>

      {% set queue_preview = queue[:6] %}
      {% set running_preview = running[:6] %}
      {% set solved_preview = solved[:6] %}
      {% set failed_preview = failed[:6] %}

      <section class="status-grid">
        {% macro status_section(title, items, hint_text, extra_class="") %}
          <article class="status-panel {{ extra_class }}">
            <header>
              <div>
                <h3>{{ title }}</h3>
                <p class="hint">{{ hint_text }}</p>
              </div>
              <span class="status-count">{{ items | length }}</span>
            </header>
            <div class="status-items">
              {% for item in items %}
                <div class="status-item" data-status="{{ item.status | lower }}">
                  <div class="status-top-row">
                    <div>
                      <p class="task-name">{{ item.task or "Mysterious Task" }}</p>
                      {% if item.challenge_id is not none and item.challenge_id != "" %}
                        <p class="task-hash">#{{ item.challenge_id }}</p>
                      {% endif %}
                    </div>
                    {% if item.detail_href %}
                      <a class="tiny-link" href="{{ item.detail_href }}">open</a>
                    {% endif %}
                  </div>
                  <div class="status-meta">
                    <span class="badge badge-{{ item.status | lower }}">{{ item.status | capitalize }}</span>
                    {% if item.timestamp %}
                      <span>{{ item.timestamp }}</span>
                    {% endif %}
                  </div>
                  {% if item.error %}
                    <p class="status-error">{{ item.error }}</p>
                  {% endif %}
                </div>
              {% else %}
                <p class="status-empty">No {{ title | lower }} yet.</p>
              {% endfor %}
            </div>
          </article>
        {% endmacro %}

        {{ status_section("Queued", queue_preview, "waiting for execution", "panel-queue") }}
        {{ status_section("Running", running_preview, "currently burning tokens", "panel-running") }}
        {{ status_section("Solved", solved_preview, "victories", "panel-solved") }}
        {{ status_section("Failed", failed_preview, "needs attention", "panel-failed") }}
      </section>
      </main>
  </body>
</html>
